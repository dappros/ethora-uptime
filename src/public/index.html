<!doctype html>
<!-- Ethora.com platform, copyright: Dappros Ltd (c) 2026, all rights reserved -->
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>Ethora Uptime</title>
    <style>
      :root { color-scheme: light dark; }
      body { font-family: ui-sans-serif, system-ui, Arial; margin: 0; padding: 16px; }
      header { display: flex; align-items: baseline; justify-content: space-between; gap: 12px; }
      .grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(260px, 1fr)); gap: 12px; margin-top: 16px; }
      .card { border: 1px solid rgba(127,127,127,0.35); border-radius: 10px; padding: 12px; }
      .status { display: inline-flex; align-items: center; gap: 8px; font-weight: 600; }
      .dot { width: 10px; height: 10px; border-radius: 999px; background: gray; display: inline-block; }
      .green { background: #2ecc71; }
      .amber { background: #f1c40f; }
      .red { background: #e74c3c; }
      table { width: 100%; border-collapse: collapse; margin-top: 10px; }
      th, td { text-align: left; padding: 6px 4px; border-bottom: 1px solid rgba(127,127,127,0.2); font-size: 13px; }
      .muted { opacity: 0.7; font-size: 12px; }
      a { color: inherit; }
      button { padding: 8px 10px; border-radius: 8px; border: 1px solid rgba(127,127,127,0.35); background: transparent; cursor: pointer; }
    </style>
  </head>
  <body>
    <header>
      <div>
        <div style="font-size:18px;font-weight:700;">Ethora Uptime</div>
        <div class="muted">Wallboard overview (green/amber/red)</div>
      </div>
      <div>
        <button id="refreshBtn">Refresh</button>
        <span class="muted" id="updatedAt"></span>
      </div>
    </header>

    <div class="grid" id="grid"></div>

    <script>
      const grid = document.getElementById('grid');
      const updatedAt = document.getElementById('updatedAt');
      const refreshBtn = document.getElementById('refreshBtn');

      function statusToClass(st) {
        if (st === 'green') return 'green';
        if (st === 'amber') return 'amber';
        if (st === 'red') return 'red';
        return '';
      }

      async function load() {
        const r = await fetch('/api/summary');
        const data = await r.json();
        grid.innerHTML = '';
        for (const inst of data.instances) {
          const card = document.createElement('div');
          card.className = 'card';
          const critical = inst.checks.filter(c => (c.severity || 'critical') === 'critical');
          const optional = inst.checks.filter(c => (c.severity || 'critical') !== 'critical');
          const buildLine = inst.build
            ? [
                // Prefer date-based buildVersion (yy.mm.dd) if present; fallback to semantic version.
                inst.build.buildVersion ? `v${inst.build.buildVersion}` : (inst.build.version ? `v${inst.build.version}` : null),
                inst.build.commit ? `commit ${String(inst.build.commit).slice(0, 12)}` : null,
                inst.build.time ? `${inst.build.time}` : null,
              ].filter(Boolean).join(' Â· ')
            : '';
          card.innerHTML = `
            <div style="display:flex;justify-content:space-between;gap:8px;">
              <div>
                <div style="font-weight:700;">${inst.name}</div>
                <div class="muted">${inst.id}</div>
                ${buildLine ? `<div class="muted">${buildLine}</div>` : ``}
              </div>
              <div class="status"><span class="dot ${statusToClass(inst.status)}"></span>${inst.status.toUpperCase()}</div>
            </div>
            <table>
              <thead><tr><th>Check</th><th>Last</th><th>ms</th></tr></thead>
              <tbody>
                ${critical.map(c => `
                  <tr>
                    <td><a href="/history.html#${encodeURIComponent(c.id)}">${c.name}</a></td>
                    <td>${c.ok ? 'OK' : ('FAIL' + (c.errorText ? ' ('+c.errorText+')' : ''))}${c.statusCode ? ' ('+c.statusCode+')' : ''}</td>
                    <td>${c.durationMs ?? ''}</td>
                  </tr>
                `).join('')}
              </tbody>
            </table>
            ${optional.length ? `
              <details style="margin-top:10px;">
                <summary class="muted">Optional checks (${optional.length})</summary>
                <table>
                  <thead><tr><th>Check</th><th>Last</th><th>ms</th><th></th></tr></thead>
                  <tbody>
                    ${optional.map(c => `
                      <tr>
                        <td><a href="/history.html#${encodeURIComponent(c.id)}">${c.name}</a></td>
                        <td>${c.ok ? 'OK' : ('FAIL' + (c.errorText ? ' ('+c.errorText+')' : ''))}${c.statusCode ? ' ('+c.statusCode+')' : ''}</td>
                        <td>${c.durationMs ?? ''}</td>
                        <td>${c.type === 'journey' ? `<button data-run="${c.id}">Run</button>` : ''}</td>
                      </tr>
                    `).join('')}
                  </tbody>
                </table>
              </details>
            ` : ''}
          `;
          grid.appendChild(card);
        }
        updatedAt.textContent = 'Updated: ' + new Date().toLocaleTimeString();

        // Wire \"Run\" buttons (journey)
        document.querySelectorAll('button[data-run]').forEach((btn) => {
          btn.addEventListener('click', async (e) => {
            const checkId = e.currentTarget.getAttribute('data-run');
            if (!checkId) return;
            e.currentTarget.disabled = true;
            try {
              await fetch('/api/run-check', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ checkId }),
              });
            } finally {
              e.currentTarget.disabled = false;
              load().catch(() => {});
            }
          });
        });
      }

      refreshBtn.addEventListener('click', () => load().catch(console.error));
      load().catch(console.error);
      setInterval(() => load().catch(() => {}), 15000);
    </script>
  </body>
</html>


